{% extends "holo_template.html" %}

{% block title %}Channels{% endblock %}

{% block main %}
    <h2 class="display-4" style="text-align: center">Channel list</h2>
    <hr>
    <div class="d-flex bd-highlight mb-0">
        <div class="mr-auto p-3 bd-highlight" >
            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#remove">Remove selected</button>
        </div>
        <div class="p-3 bd-highlight" >
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#add">Add channel</button>
        </div>

<!-- Modal -->
<div class="modal fade" id="remove" tabindex="-1" aria-labelledby="RemovePrompt" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="RemovePrompt">Remove channels</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Do you really want to remove these channels from the database?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger">Remove</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="add" tabindex="-1" aria-labelledby="AddForm" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="AddForm">Add channel</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="chan-url">Channel URL(or URLs separated by comma)</label>
            <input type="url" class="form-control" id="chan-url">
          </div>
          <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="video-download" checked>
            <label class="form-check-label" for="video-download">Download videos?</label>
          </div>
          <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="stream-download" checked>
            <label class="form-check-label" for="stream-download">Capture streams?</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="add_channel(this)">Submit</button>
      </div>
    </div>
  </div>
</div>



    </div>
    <div class="container-fluid ">
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th scope="col">#
                    <label class="form-check-label">
                        <input type="checkbox" onclick="toggle(this)" readonly>
                    </label>
                </th>
                <th scope="col">Name</th>
                <th scope="col">URL</th>
                <th scope="col">Videos</th>
                <th scope="col">Streams</th>
            </tr>
            </thead>
            <tbody class="align-items-center">
            {% if channels %}
                {% for channel in channels %}
                    <tr>
                        <th scope="row">
                            <label class="form-check-label">
                                {{ loop.index }} <input name="chan-checkbox" type="checkbox" readonly
                                                        id="{{ channel["id"] }}">
                            </label>
                        </th>
                        <td>{{ channel["name"] }}</td>
                        <td><a href="{{ channel["url"] }}" target="_blank">{{ channel["url"] }}</a></td>
                        <td>
                            <div style="margin-top: auto;margin-bottom: auto;text-align: center;">
                                <label class="form-check-label">
                                    {% if channel["downloadvideos"] =="True" %}
                                        <input type="checkbox" checked readonly>
                                    {% else %}
                                        <input type="checkbox" readonly>
                                        </label>
                                    {% endif %}
                            </div>
                        </td>
                        <td>
                            <div style="margin-top: auto;margin-bottom: auto;text-align: center;">
                                <label class="form-check-label">
                                    {% if channel["downloadstreams"] =="True" %}
                                        <input type="checkbox" checked readonly>
                                    {% else %}
                                        <input type="checkbox" readonly>
                                    {% endif %}
                                </label>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td style="text-align: center" colspan="5">Could not find any records.</td>
                </tr>
            {% endif %}
            </tbody>
        </table>

    </div>

{% endblock %}

{% block script %}
    <script>
        async function fetchWithTimeout(resource, options) {
          const { timeout = 8000 } = options;

          const controller = new AbortController();
          const id = setTimeout(() => controller.abort(), timeout);

          const response = await fetch(resource, {
            ...options,
            signal: controller.signal
          });
          clearTimeout(id);

          return response;
        }
        function toggle(source) {
            checkboxes = document.getElementsByName('chan-checkbox');
            for (var i = 0, n = checkboxes.length; i < n; i++) {
                checkboxes[i].checked = source.checked;
            }
        }
        function add_channel(source){
            var url = document.getElementById("chan-url");
            var dlvideo = document.getElementById("video-download");
            var dlstream = document.getElementById("stream-download");
            var data = {
                url:url.value,
                dlvideo:dlvideo.value,
                dlstream:dlstream.value
                };
            if (url.value) {
                $(source).prop("disabled", true);
                $(source).html(
                    `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>Adding...`
                );
                fetchWithTimeout(`${window.origin}/channels/add-channel`, {
                    method: "POST",
                    credentials: "include",
                    body: JSON.stringify(data),
                    cache: "no-cache",
                    headers: new Headers({
                        "content-type":"application/json"
                    })
                }).then(function(response) {
                    console.log(response.status);
                    if (response.ok) {
                        location.reload();
                    }
                })
            }
            else alert("URL can't be empty!");

        }

    </script>
{% endblock %}